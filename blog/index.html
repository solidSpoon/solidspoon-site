<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Blog | solidSpoon&#x27;s site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://solidspoon.xyz/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://solidspoon.xyz/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://solidspoon.xyz/blog"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" property="og:title" content="Blog | solidSpoon&#x27;s site"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/logoo.svg"><link data-rh="true" rel="canonical" href="https://solidspoon.xyz/blog"><link data-rh="true" rel="alternate" href="https://solidspoon.xyz/blog" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://solidspoon.xyz/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="solidSpoon&#39;s site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="solidSpoon&#39;s site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.93b573f6.css">
<script src="/assets/js/runtime~main.fd63c0f1.js" defer="defer"></script>
<script src="/assets/js/main.fdd1290a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logoo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logoo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Hide</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/app/dash-player">DashPlayer</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_brwN flex flex-col" aria-label="最近博文导航"><div class="sidebarItemTitle_r4Q1 margin-bottom--md">All posts</div><div class="w-full flex-1 overflow-y-auto thin-scrollbar"><ul class="sidebarItemList_QwSx clean-list"><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/inventory-lock-master">锁库大师</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/exploring-mongodb">MongoDB 初探</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/clash-for-windows-tap-mode-cannot-connect-to-network-normally">ClashForWindows tap 模式无法正常连接网络</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/java-functional-programming-explained">Java 函数式编程详解</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/custom-class-loader-loads-encrypted-class-file">自定义 ClassLoader 加载一个加密 class 文件</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/step-by-step-guide-to-reading-bytecode-of-a-java-file">手把手教你读一个 Java 文件的字节码</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/getting-started-with-jshell">初识 JShell</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/an-essay">一篇散文</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/article-formatting-guide">文章排版指南</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/building-a-simple-and-user-friendly-note-taking-system">搭建简单好用的笔记系统</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/git-is-a-purely-functional-data-structure">Git 是纯函数式数据结构</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/how-to-visually-edit-web-page-elements">怎么直观地给网页「P 图」</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/matching-multiples-of-3-with-regular-expressions">如何用正则表达式匹配 3 的倍数</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/multi-cursor-feature-in-vs-code">VsCode 多光标特性</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/reflections-on-movie-the-island">一出好戏有感</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/removing-or-modifying-occupied-files-in-windows">删除或修改 Windows 中被占用的文件</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/several-methods-to-view-docker-ip">查看 Docker IP 的几种方法</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/the-intriguing-three-way-handshake-and-four-way-farewell-in-tcp-1">有趣的三次握手与四次挥手 1</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/algorithm-fourth-edition-answer-series-1-3-exercise-article">文章排版指南</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/algorithm-fourth-edition-answer-series-1-3-linked-list-exercises">《算法-第四版》答 案系列-1-3 链表练习</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/algorithm-fourth-edition-answer-series-1-2-advanced-exercise-article">《算法-第四版》答案系列-1.2 提高题篇</a></li><li class="sidebarItem_lnhn"><a class="sidebarItemLink_yNGZ" href="/blog/algorithm-fourth-edition-answer-series-1-2-exercise-article">《算法-第四版》答案系列-1.2 练习篇</a></li></ul></div></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="背景"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/inventory-lock-master">锁库大师</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-06-16T00:00:00.000Z" itemprop="datePublished">2022年6月16日</time> · <!-- -->阅读需 11 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2>
<p>希望在顾客下单时对库存明细表中的商品进行库存锁定，库存明细表简化后如下所示：</p>
<p><img loading="lazy" src="https://ced-md-picture.oss-cn-beijing.aliyuncs.com/img/202206130943348.png" alt="背景" class="img_ev3q"></p>
<p>可见一条产品编码有可能存在多条库存明细，客户的订单大致会锁定几十行的库存，要求如下：</p>
<ul>
<li>尽可能快，并发也高，支持多节点</li>
<li>为了数据的一致性，最好不用 redis 扣减的方案</li>
<li>锁库同时在锁库流水表中插入锁库记录</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="优化方案">优化方案<a href="#优化方案" class="hash-link" aria-label="优化方案的直接链接" title="优化方案的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分析">分析<a href="#分析" class="hash-link" aria-label="分析的直接链接" title="分析的直接链接">​</a></h3>
<p>通过分析系统现有的方案，发现锁库操作时间主要浪费在更新库存明细的锁库数量上，为了防止超卖，每一条更新必须加上库存校验（如下所示），一旦失败就要回滚，在加之 MySQL 并没有提供原生批量更新方法，只能每行库存执行一条 SQL，导致锁库时间较长。</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stock_quantity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> locking_quantity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="提高锁库速度">提高锁库速度<a href="#提高锁库速度" class="hash-link" aria-label="提高锁库速度的直接链接" title="提高锁库速度的直接链接">​</a></h3>
<p>优化的第一步就是想要提高批量锁库的速度，有没有方法能够在 MySQL 中模拟批量更新呢？</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="when-语句">WHEN 语句<a href="#when-语句" class="hash-link" aria-label="WHEN 语句的直接链接" title="WHEN 语句的直接链接">​</a></h4>
<p>答案就是使用 SQL 的 <code>when</code> 语句，在程序中拼接出如下的 SQL</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> p_stock_instance a  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CASE</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;027dbba9c04a4ef0baab3983c64bc0b31123&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;025d4574cd934b69993703e7e99e8ca43&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;027dbba9c04a4ef0baab3983c64bc0b313&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">update_date      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CASE</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;027dbba9c04a4ef0baab3983c64bc0b31123&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_quantity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;025d4574cd934b69993703e7e99e8ca43&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_quantity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;027dbba9c04a4ef0baab3983c64bc0b313&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_quantity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">ELSE</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>SQL 执行完毕后会返回更新行数，在程序中判断更新行数是否与预期相符即可判断是否更新成功，程序示意如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Integer num = pStockInstanceDao.operationStockSmallData(operationMapping);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (num != operationMapping.size()) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new RuntimeException(&quot;操作失败&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这种方法的更新速度很快，在我的测试中，更新两万行库存记录的耗时大约 17 秒。但其实还有更快的方法。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="临时表">临时表<a href="#临时表" class="hash-link" aria-label="临时表的直接链接" title="临时表的直接链接">​</a></h4>
<p>使用<strong>临时表更新库存</strong>的方法在数据量比较大的情况下比 WHEN 语句的性能好很多，测试条件下更新两万行库存记录耗时大约 1 秒</p>
<p>临时表是 MySQL 中的一种特殊表，他有如下几个特征：</p>
<ul>
<li>临时表是线程内可见，线程之间看不到其他线程创建的临时表</li>
<li>线程推出后临时表就被销毁</li>
<li>临时表与普通表重名时 MySQL 优先选择临时表操作</li>
</ul>
<p>本案例中创建临时表的语句如下：</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">temporary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> temp_stock_operation  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stock_instance_id </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unique</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;库存实例ID&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    op_num            </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">                  </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;操作数量&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    success           </span><span class="token keyword" style="color:#00009f">tinyint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">default</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;是否成功&#x27;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>stock_instance_id</code> 就是库存明细表中的 <code>id</code></p>
<p><strong>更新库存时</strong>：</p>
<ol>
<li>创建临时表</li>
<li>先将每一行库存明细要锁定的库存数量插入到临时表中</li>
<li>然后通过 UPDATE JOIN 语句批量更新库存，同时将是否更新成功的信息保存在临时表的 <code>success</code> 字段中</li>
<li>统计 <code>success</code> 字段，判断是否回滚</li>
<li>删除临时表</li>
</ol>
<p>使用的 UPDATE 语句如下：</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> temp_stock_operation o </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> p_stock_instance s  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_instance_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success          </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op_num  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_quantity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op_num  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>检查是否成功，该语句返回值为 0 或 1 。</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> success  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> temp_stock_operation  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后删除临时表：</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">drop</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">temporary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> temp_stock_operation</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="将二者结合">将二者结合<a href="#将二者结合" class="hash-link" aria-label="将二者结合的直接链接" title="将二者结合的直接链接">​</a></h4>
<p>虽然使用临时表的方案更新大量数据时很快，但是如果使用这个方法来更新几十条库存时就会发现速度又变慢了，在我的测试中，更新三四十条的耗时几乎与更新两万条相等。</p>
<p>就是说这条更新语句在数量少的时候性能会下降</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> temp_stock_operation o </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> p_stock_instance s  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_instance_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success          </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op_num  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_quantity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op_num  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>分析它的执行计划，发现当更新行数小于 45 时，JOIN 操作便不会走索引，而是全表扫描，导致性能下降。这时候即使使用下面的 SQL 语句强制索引也是<strong>没用的</strong>。</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">update</span><span class="token plain"> temp_stock_operation o </span><span class="token keyword" style="color:#00009f">force</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">index</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stock_instance_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">inner</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> p_stock_instance s  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_instance_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">set</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success          </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op_num  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stock_quantity </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locking_quantity </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op_num  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">and</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以我们要将这两种方法结合，来获得最佳的性能</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (operationMapping.size() &lt; 45) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // WHEN 语句方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Integer num = pStockInstanceDao.operationStockSmallData(operationMapping);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (num != operationMapping.size()) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new RuntimeException(&quot;操作失败&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 临时表方案</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Boolean success = pStockInstanceDao.operationStockBigData(operationMapping);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!success) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new RuntimeException(&quot;操作失败&quot;);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="提高并发量">提高并发量<a href="#提高并发量" class="hash-link" aria-label="提高并发量的直接链接" title="提高并发量的直接链接">​</a></h3>
<p>由于并发时多个线程间存在竞态条件，可能导致库存扣减失败，而前面说到库存明细表中一件商品可能对应多条库存明细，就是说如果并发导致有一条库存明细扣减失败的话很可能这个商品在其他的库存明细中还有库存。而且由于无论更没更新成功，线程都会占有数据库行的写锁，这就要求我们更新失败时最好能够快速释放锁，这又会导致接口会误报库存不足。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="商品编码锁">商品编码锁<a href="#商品编码锁" class="hash-link" aria-label="商品编码锁的直接链接" title="商品编码锁的直接链接">​</a></h4>
<p>一个解决办法如下</p>
<ol>
<li>线程在执行库存数量查询前为订单中的每个商品编码获取一个分布式锁，只有获得全部商品编码的锁时才进行库存的查询操作</li>
<li>线程在更新完库存后释放所持有的商品编码锁</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RLock[] locks = productSids.seream()  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .distinct()  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(key -&gt; &quot;ced:pStockInstance:&quot; + key)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .sorted()  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(key -&gt; redissonClient.getLock(key))  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .toArray(RLock[]::new);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RLock skuLock = redissonClient.getMultiLock(locks);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 加锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skuLock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 解锁</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">skuLock.unlockAsync();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这种方法当所有的订单都锁定同一个商品时就会导致程序退化成串行执行，效率很慢。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="和并请求">和并请求<a href="#和并请求" class="hash-link" aria-label="和并请求的直接链接" title="和并请求的直接链接">​</a></h4>
<p>由于前文我们已经将库存更新的方法优化的足够快，因此想高效地解决竞态条件的问题，可以将各个请求的参数在应用程序中合并在一起，然后使用一个线程批量扣减，从而避免线程间扣减冲突。</p>
<p><img loading="lazy" src="https://ced-md-picture.oss-cn-beijing.aliyuncs.com/img/202206130944601.png" alt="合并请求" class="img_ev3q"></p>
<p>使线程阻塞并被唤醒的关键代码如下</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class GuardedObject&lt;T, K&gt; {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //受保护的对象  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    T obj;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Lock lock = new ReentrantLock();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Condition done = lock.newCondition();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final int timeout = 60;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //保存所有GuardedObject  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final static Map&lt;Object, GuardedObject&gt; gos = new ConcurrentHashMap&lt;&gt;();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GuardedObject(K key) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.key = key;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    K key;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. 被请求线程通过唯一 key 获得阻塞对象，然后将 key 存入消息，发送到扣减中心  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static &lt;K&gt; GuardedObject create(K key) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GuardedObject go = new GuardedObject(key.toString());  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        gos.put(key, go);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return go;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. 被请求线程稍后调用阻塞对象的该方法，阻塞，等待被唤醒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Optional&lt;T&gt; get(Predicate&lt;T&gt; p) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Long start = System.currentTimeMillis();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (!p.test(obj)) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                done.await(timeout, TimeUnit.SECONDS);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (System.currentTimeMillis() - start &gt;= timeout * 1000) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    gos.remove(key);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Optional.ofNullable(obj);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(e);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3. 结果监听器根据结果消息中的 key 找到对应阻塞对象，传入结果并唤醒对应线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static &lt;K, T&gt; void fireEvent(K key, T obj) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GuardedObject go = gos.remove(key);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (go != null) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            go.onChanged(obj);  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //事件通知方法  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onChanged(T obj) {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.obj = obj;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            done.signalAll();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="性能测试">性能测试<a href="#性能测试" class="hash-link" aria-label="性能测试的直接链接" title="性能测试的直接链接">​</a></h2>
<p>实验环境为了获得最坏情况下的性能，在库存明细中存入了两万五千条同一商品，并将每一条的数据的库存数量设置为 1</p>
<p>在我的电脑中启动两个服务接收请求，启动若干线程对该商品进行扣减，结果如下</p>
<table><thead><tr><th>请求线程数量</th><th>总计锁库行数</th><th>全部处理耗时</th></tr></thead><tbody><tr><td>100</td><td>1000</td><td>1 S</td></tr><tr><td>500</td><td>5000</td><td>3 S</td></tr><tr><td>1000</td><td>10000</td><td>4 S</td></tr><tr><td>2000</td><td>20000</td><td>8 S</td></tr><tr><td>3000</td><td>25000</td><td>12 S</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="注意事项">注意事项<a href="#注意事项" class="hash-link" aria-label="注意事项的直接链接" title="注意事项的直接链接">​</a></h2>
<p>以下是我在编写代码时发现的一些需要注意的点：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="唯一索引">唯一索引<a href="#唯一索引" class="hash-link" aria-label="唯一索引的直接链接" title="唯一索引的直接链接">​</a></h3>
<p>在创建临时表时 <code>stock_instance_id</code> 要创建唯一索引，因为这个字段要充当 JOIN 语句的条件，实测不加唯一索引性能会很差。</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">create</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">temporary</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">table</span><span class="token plain"> temp_stock_operation  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stock_instance_id </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unique</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">null</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">comment</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;库存实例ID&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="加快消息队列读取">加快消息队列读取<a href="#加快消息队列读取" class="hash-link" aria-label="加快消息队列读取的直接链接" title="加快消息队列读取的直接链接">​</a></h3>
<p>扣减中心的库存扣减线程直接从消息队列读取消息效率较低，在本案例中，可以新建一个本地队列，用其他线程将消息队列中的消息搬运到本地队列，让扣减线程操作本地队列而不是消息队列，这样可以大幅提高扣减效率。</p>
<hr>
<p>源码请见：<a href="https://github.com/solidSpoon/inventory-lock-master" target="_blank" rel="noopener noreferrer">https://github.com/solidSpoon/inventory-lock-master</a></p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="对于已经熟悉 MySQL 的同学来说，初次接触 MongoDB 可能会不习惯它的语法，本篇文章将通过一个简单的示例带你入门 MongoDB。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/exploring-mongodb">MongoDB 初探</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-04-11T00:00:00.000Z" itemprop="datePublished">2022年4月11日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>对于已经熟悉 MySQL 的同学来说，初次接触 MongoDB 可能会不习惯它的语法，本篇文章将通过一个简单的示例带你入门 MongoDB。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="准备">准备<a href="#准备" class="hash-link" aria-label="准备的直接链接" title="准备的直接链接">​</a></h2>
<p>对于 MongoDB 新手，可以借助 DataGrip 来学习MongoDB 语法。在 MongoDB 中实现准备好两个表 &quot;old&quot; 和 &quot;new&quot;，并随意插入一些数据</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createCollection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createCollection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;old&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">old</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">insertOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> old  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">new</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">insertOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">goods</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 随意插入数据</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 DataGrip 中输入如下的 SQL 语句</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> aleft </span><span class="token keyword" style="color:#00009f">left</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">join</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;old&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> bright </span><span class="token keyword" style="color:#00009f">on</span><span class="token plain"> aleft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bright</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后在这条语句上「右键」，选择 「Show JS Script」，会发现 DataGrip 会帮助我们将 SQL 语句转为 MongoDB 语句，接下来我们通过研究这个语句来体会 MongoDB 的基本思想</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getSiblingDB</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getCollection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;new&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">aggregate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">$project</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;aleft&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$$ROOT&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-property property" style="color:#36acaa">&quot;_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">$lookup</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">localField</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;aleft.id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword module" style="color:#00009f">from</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;old&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">foreignField</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword module" style="color:#00009f">as</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bright&quot;</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">$unwind</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$bright&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">preserveNullAndEmptyArrays</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">$replaceRoot</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">newRoot</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">$mergeObjects</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;$aleft&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$bright&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;$$ROOT&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">$project</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;aleft&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-property property" style="color:#36acaa">&quot;bright&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析">分析<a href="#分析" class="hash-link" aria-label="分析的直接链接" title="分析的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aggregate">aggregate<a href="#aggregate" class="hash-link" aria-label="aggregate的直接链接" title="aggregate的直接链接">​</a></h3>
<p><code>db.collection.aggregate(管道，选项)</code> 方法参数接收一个包含了若干操作的数组，类似于 Linux 中的管道一样，对集合依次进行操作。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="project">project<a href="#project" class="hash-link" aria-label="project的直接链接" title="project的直接链接">​</a></h3>
<p>第一个操作为 <code>$project</code> ，这是一个映射操作</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $project: {&quot;aleft&quot;: &quot;$$ROOT&quot;, &quot;_id&quot;: 0}  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中 <code>$$ROOT</code> 即引用顶级文档，效果是将当前文档（行）的所有数据放到 <code>aleft</code> 字段下。<code>&quot;_id&quot;: 0</code> 代表隐藏 <code>_id</code> 行，当设定为 <code>&quot;_id&quot;: 1</code> 时会展示 <code>_id</code> 行，（<code>_id</code> 由 MongoDB 自动生成）结果示意如下：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 12  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce445b67f62529d94a83e&quot;}, // 当 _id: 1 时会展示 id </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce445b67f62529d94a83e&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 2,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 13,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;goods&quot;: 1  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lookup">lookup<a href="#lookup" class="hash-link" aria-label="lookup的直接链接" title="lookup的直接链接">​</a></h3>
<p>第二个操作为</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $lookup: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      localField: &quot;aleft.id&quot;,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      from: &quot;old&quot;,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      foreignField: &quot;id&quot;,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      as: &quot;bright&quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>顾名思义，这是一个查找操作，它根据第一步结果中的 <code>aleft.id</code> 字段，在 <code>old</code> 表中查找 <code>id</code> 与之相等的文档（行），并将所有匹配的结果以数组方式放在 <code>bright</code> 字段下，结果示意如下：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 12  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bright&quot;: [  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce82ab67f62529d94a84c&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce867b67f62529d94a84e&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;vbsss&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unwind">unwind<a href="#unwind" class="hash-link" aria-label="unwind的直接链接" title="unwind的直接链接">​</a></h3>
<p>第三个操作为</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $unwind: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      path: &quot;$bright&quot;,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      preserveNullAndEmptyArrays: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个操作指明了使用 <code>$bright</code> 字段，这个字段是一个数组，<code>$unwind</code> 操作会将 <code>$bright</code> 中的每一个元素与 <code>aleft</code> 组合</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 12  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bright&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce82ab67f62529d94a84c&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 12  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bright&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce867b67f62529d94a84e&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;vbsss&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至此，我们已经将两个表中关联的行组合在了一起，接下来需要将这个结构简化一下</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="replaceroot">replaceRoot<a href="#replaceroot" class="hash-link" aria-label="replaceRoot的直接链接" title="replaceRoot的直接链接">​</a></h3>
<p>第四个操作为</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $replaceRoot: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      newRoot: {$mergeObjects: [&quot;$aleft&quot;, &quot;$bright&quot;, &quot;$$ROOT&quot;]}  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mergeobjects">mergeObjects<a href="#mergeobjects" class="hash-link" aria-label="mergeObjects的直接链接" title="mergeObjects的直接链接">​</a></h3>
<p><code>$mergeObjects</code> 操作会将参数中元素的内容进行合并，如果有重复，后面的值会覆盖前面的值，比如下面的这个文档</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 12  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bright&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce82ab67f62529d94a84c&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行 <code>$mergeObjects: [&quot;$aleft&quot;, &quot;$bright&quot;, &quot;$$ROOT&quot;]</code> 操作后结果如下</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 12  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bright&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce82ab67f62529d94a84c&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="replaceroot-1">replaceRoot<a href="#replaceroot-1" class="hash-link" aria-label="replaceRoot的直接链接" title="replaceRoot的直接链接">​</a></h3>
<p><code>$replaceRoot</code> 将指定的文档提升到顶层，并丢弃顶层所有其他字段。</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;aleft&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: 12  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;bright&quot;: {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;_id&quot;: {&quot;$oid&quot;: &quot;624ce82ab67f62529d94a84c&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至此，只要将 <code>aleft</code> 和 <code>bright</code> 两个参数删掉就得到了最后的结果，操作为</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $project: {&quot;aleft&quot;: 0, &quot;bright&quot;: 0}  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>结果示意如下</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;_id&quot;: {&quot;$oid&quot;: &quot;6247f1e253a1be11c3b88d8b&quot;},  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;id&quot;: 1,  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;haha&quot;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="其他">其他<a href="#其他" class="hash-link" aria-label="其他的直接链接" title="其他的直接链接">​</a></h2>
<p>MongoDB 中的 JOIN 操作还是十分复杂的，与 MySQL 不同， MongoDB 中的文档结构并没有限制，所以可以采用<a href="https://www.mongodb.com/docs/v4.2/tutorial/query-embedded-documents/" target="_blank" rel="noopener noreferrer">嵌套文档</a>的方式将本来需要关联的数据保存在一起，从而避免 JOIN 操作</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mongo-db">MongoDB</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="ClashForWindows 正常情况下只能代理通过 Http 或 Socks 代理工作。这两种协议工作在网络模型中的较高层级，可能无法代理系统全部的流量，比如对 SSH 或 WSL 等不起作用，使用时需要对这些应用单独配置。其实下面这几个选项可以让 ClashForWindows 有能力在 TCP/IP 层级工作，从而代理系统全部流量，具体的教程参见官方文档"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/clash-for-windows-tap-mode-cannot-connect-to-network-normally">ClashForWindows tap 模式无法正常连接网络</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2022-02-14T00:00:00.000Z" itemprop="datePublished">2022年2月14日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>ClashForWindows 正常情况下只能代理通过 Http 或 Socks 代理工作。这两种协议工作在网络模型中的较高层级，可能无法代理系统全部的流量，比如对 SSH 或 WSL 等不起作用，使用时需要对这些应用单独配置。其实下面这几个选项可以让 ClashForWindows 有能力在 TCP/IP 层级工作，从而代理系统全部流量，具体的教程参见<a href="https://docs.cfw.lbyczf.com/contents/tun.html#windows" target="_blank" rel="noopener noreferrer">官方文档</a></p>
<p><img loading="lazy" src="https://ced-md-picture.oss-cn-beijing.aliyuncs.com/img/2021/12/02/20211202-230605.png" alt="image-20211202230604161" class="img_ev3q"></p>
<p>这里主要提一下通过官方文档操作之后无法正常代理的情况，这种情况 GitHub 的 issue 上已经有了解决方案，<a href="https://github.com/Fndroid/clash_for_windows_pkg/issues/1243" target="_blank" rel="noopener noreferrer">链接</a>。如果你也连不上网，不妨排查一下网卡的驱动或相关应用</p>
<p><img loading="lazy" src="https://ced-md-picture.oss-cn-beijing.aliyuncs.com/img/2021/12/02/20211202-231144.png" alt="image-20211202231142928" class="img_ev3q"></p>
<p>使用上述方法代理系统全部流量时，可以关闭 ClashForWindows 的 System Proxy 开关，也会正常工作。</p>
<p>需要提及一下，这种方法虽然可以代理全部系统流量，看起来十分强大，但它的性能不如直接使用 Http 或 Socks 代理，所以还是要看情况使用不同的代理方案。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/教程">教程</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="概要"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/java-functional-programming-explained">Java 函数式编程详解</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-09-25T00:00:00.000Z" itemprop="datePublished">2021年9月25日</time> · <!-- -->阅读需 14 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="概要">概要<a href="#概要" class="hash-link" aria-label="概要的直接链接" title="概要的直接链接">​</a></h2>
<p>首先一个简单的示例展示一下什么是函数式编程</p>
<p>假设我们有一个「Person」列表</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;Person&gt; people = List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;John&quot;, MALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Maria&quot;, FEMALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Aisha&quot;, FEMALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Alex&quot;, MALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Alice&quot;, FEMALE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>「Person」的定义如下</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private record Person(String name, Gender gender) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enum Gender {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MALE, FEMALE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果我们想在列表中找到 FEMALE，我们可以使用这样的命令式方法</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;Person&gt; females = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (Person person : people) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (FEMALE.equals(person.gender)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        females.add(person);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (Person female : females) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(female);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>但它在声明式方法中更简洁</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Predicate&lt;Person&gt; personPredicate = person -&gt; FEMALE.equals(person.gender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var females2 = people.stream().filter(personPredicate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//          .forEach(System.out::println);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">females2.forEach(System.out::println);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>完整代码如下：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Person&gt; people = List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new Person(&quot;John&quot;, MALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new Person(&quot;Maria&quot;, FEMALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new Person(&quot;Aisha&quot;, FEMALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new Person(&quot;Alex&quot;, MALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new Person(&quot;Alice&quot;, FEMALE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Imperative approach&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Imperative approach</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Person&gt; females = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Person person : people) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (FEMALE.equals(person.gender)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                females.add(person);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Person female : females) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(female);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Declarative approach</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Declarative approach&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Predicate&lt;Person&gt; personPredicate = person -&gt; FEMALE.equals(person.gender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var females2 = people.stream().filter(personPredicate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                .forEach(System.out::println);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        females2.forEach(System.out::println);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private record Person(String name, Gender gender) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum Gender {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MALE, FEMALE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="function-and-bifunction">Function and BiFunction<a href="#function-and-bifunction" class="hash-link" aria-label="Function and BiFunction的直接链接" title="Function and BiFunction的直接链接">​</a></h2>
<p><code>Function</code> 表示接受一个参数 &lt;T&gt; 并产生结果 &lt;R&gt; 的函数。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Function&lt;T, R&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以下是 <code>Function</code> 的一些例子</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static Function&lt;Integer, Integer&gt; incrementByOneFunction = number -&gt; number + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Function&lt;Integer, Integer&gt; multiplyBy10Function = number -&gt; number * 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var increment2 = incrementByOneFunction.apply(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var multiply = multiplyBy10Function.apply(increment2);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>酷，如果你看不懂，那么我们之前用命令式编程是这么写的</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static int incrementByOne(int number) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return number + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var increment = incrementByOne(1);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>更进一步，我们可以结合两个 Function</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var addBy1AndThenMultiplyBy10 = incrementByOneFunction.andThen(multiplyBy10Function);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var ans = addBy1AndThenMultiplyBy10.apply(4);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>BiFunction</code> 表示一个接受两个参数并产生结果的函数。</p>
<p>作为对比，这是一个传统的二参数方法</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static int incrementByOneAndMultiply(int number, int numberToMultiplyBy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (number + 1) * numberToMultiplyBy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">incrementByOneAndMultiply(4, 100);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在函数式编程中，我们这样写</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static BiFunction&lt;Integer, Integer, Integer&gt; incrementByOneAndMultiplyBiFunction =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (numberToIncrementByOne, numberToMultiplyBy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                -&gt; (numberToIncrementByOne + 1) * numberToMultiplyBy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">incrementByOneAndMultiplyBiFunction.apply(4, 100);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>完整代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class _Function {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Function takes 1 argument and produce 1 result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var increment = incrementByOne(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(increment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var increment2 = incrementByOneFunction.apply(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(increment2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var multiply = multiplyBy10Function.apply(increment2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(multiply);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var addBy1AndThenMultiplyBy10 = incrementByOneFunction.andThen(multiplyBy10Function);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var ans = addBy1AndThenMultiplyBy10.apply(4);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(ans);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // BiFunction takes 2 argument and produce 1 result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(incrementByOneAndMultiply(4, 100));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(incrementByOneAndMultiplyBiFunction.apply(4, 100));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static Function&lt;Integer, Integer&gt; incrementByOneFunction = number -&gt; number + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static Function&lt;Integer, Integer&gt; multiplyBy10Function = number -&gt; number * 10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static int incrementByOne(int number) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return number + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static BiFunction&lt;Integer, Integer, Integer&gt; incrementByOneAndMultiplyBiFunction =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (numberToIncrementByOne, numberToMultiplyBy)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt; (numberToIncrementByOne + 1) * numberToMultiplyBy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static int incrementByOneAndMultiply(int number, int numberToMultiplyBy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (number + 1) * numberToMultiplyBy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="consumer-and-biconsumer">Consumer and BiConsumer<a href="#consumer-and-biconsumer" class="hash-link" aria-label="Consumer and BiConsumer的直接链接" title="Consumer and BiConsumer的直接链接">​</a></h2>
<p><code>Consumer</code> 表示接受单个输入参数并且不返回结果的操作。与大多数其他 Functional interface 不同，<strong><code>Consumer</code> 预计通过副作用进行操作</strong>。</p>
<p>我们的 <code>Customer</code> 定义如下</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static record Customer(String customerName, String customerPhoneNumber) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var maria = new Customer(&quot;Maria&quot;, &quot;99999&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在命令式编程中，我们这样编写代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static void greetConsumer(Customer customer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + customer.customerPhoneNumber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">greetConsumer(maria);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在函数式编程中，我们这样编写代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static Consumer&lt;Customer&gt; greetCustomerConsumer = customer -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + customer.customerPhoneNumber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">greetCustomerConsumer.accept(maria);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>BiConsumer</code> 是 <code>Consumer</code> 的二参数版本，它表示一个接受两个输入参数并且不返回结果的操作。</p>
<p>我们通常编写下面这种命令式编程方法</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static void greetConsumerV2(Customer customer, boolean showPhoneNumber) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + (showPhoneNumber ? customer.customerPhoneNumber : &quot;*********&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">greetConsumerV2(maria, false);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是函数式编程版本</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static BiConsumer&lt;Customer, Boolean&gt; greetCustomerConsumerV2 = (customer, showPhoneNumber) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + (showPhoneNumber ? customer.customerPhoneNumber : &quot;*********&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">greetCustomerConsumerV2.accept(maria, false);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>全部代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class _Consumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var maria = new Customer(&quot;Maria&quot;, &quot;99999&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Normal java function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        greetConsumer(maria);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Consumer Functional interface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        greetCustomerConsumer.accept(maria);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        greetCustomerConsumerV2.accept(maria, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        greetConsumerV2(maria, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static BiConsumer&lt;Customer, Boolean&gt; greetCustomerConsumerV2 = (customer, showPhoneNumber) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + (showPhoneNumber ? customer.customerPhoneNumber : &quot;*********&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static Consumer&lt;Customer&gt; greetCustomerConsumer = customer -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + customer.customerPhoneNumber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void greetConsumer(Customer customer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + customer.customerPhoneNumber);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void greetConsumerV2(Customer customer, boolean showPhoneNumber) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Hello&quot; + customer.customerName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;, thanks for registering phone number &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + (showPhoneNumber ? customer.customerPhoneNumber : &quot;*********&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static record Customer(String customerName, String customerPhoneNumber) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="predicate">Predicate<a href="#predicate" class="hash-link" aria-label="Predicate的直接链接" title="Predicate的直接链接">​</a></h2>
<p><code>Predicate</code> 表示一个布尔值函数</p>
<p>在命令式编程中通过这样写达到相同目的</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static boolean isPhoneNumberValid(String phoneNumber) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return phoneNumber.startsWith(&quot;07&quot;) &amp;&amp; phoneNumber.length() == 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var phoneNumberValid = isPhoneNumberValid(&quot;07000000000&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在函数式编程中，你可以这样写</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static Predicate&lt;String&gt; isPhoneNumberValidPredicate = phoneNumber -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        phoneNumber.startsWith(&quot;07&quot;) &amp;&amp; phoneNumber.length() == 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Predicate&lt;String&gt; containsNumber3 = phoneNumber -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        phoneNumber.contains(&quot;3&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(isPhoneNumberValidPredicate.test(&quot;09009877300&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Is phone number valid and contains number 3 = &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isPhoneNumberValidPredicate.and(containsNumber3).test(&quot;07009877300&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var isPhoneNumberValidAndContainsNumber3 = isPhoneNumberValidPredicate.or(containsNumber3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Is phone number valid or contains number 3 = &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                isPhoneNumberValidAndContainsNumber3.test(&quot;07000000000&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>还记得我们在概要中写的代码 <code>stream().filter()</code> 吗？</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var females2 = people.stream().filter(person -&gt; FEMALE.equals(person.gender))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .collect(Collectors.toList());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>filter</code> 接收的参数就是 <code>Predicate</code> ，在 idea 中使用快捷键 「Ctrl + Alt + V」将它的参数提取成变量，我们就会看到 <code>Predicate</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Predicate&lt;Person&gt; personPredicate = person -&gt; FEMALE.equals(person.gender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var females2 = people.stream().filter(personPredicate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .collect(Collectors.toList());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>完整代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class _Predicate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Without predicate&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var phoneNumberValid = isPhoneNumberValid(&quot;07000000000&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(phoneNumberValid);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(isPhoneNumberValid(&quot;0700000000&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(isPhoneNumberValid(&quot;09009877300&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;With Predicate&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(isPhoneNumberValidPredicate.test(&quot;07000000000&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(isPhoneNumberValidPredicate.test(&quot;0700000000&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(isPhoneNumberValidPredicate.test(&quot;09009877300&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Is phone number valid and contains number 3 = &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        isPhoneNumberValidPredicate.and(containsNumber3).test(&quot;07009877300&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var isPhoneNumberValidAndContainsNumber3 = isPhoneNumberValidPredicate.or(containsNumber3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Is phone number valid or contains number 3 = &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        isPhoneNumberValidAndContainsNumber3.test(&quot;07000000000&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static boolean isPhoneNumberValid(String phoneNumber) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return phoneNumber.startsWith(&quot;07&quot;) &amp;&amp; phoneNumber.length() == 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static Predicate&lt;String&gt; isPhoneNumberValidPredicate = phoneNumber -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            phoneNumber.startsWith(&quot;07&quot;) &amp;&amp; phoneNumber.length() == 11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static Predicate&lt;String&gt; containsNumber3 = phoneNumber -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            phoneNumber.contains(&quot;3&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="supplier">Supplier<a href="#supplier" class="hash-link" aria-label="Supplier的直接链接" title="Supplier的直接链接">​</a></h2>
<p><code>Supplier</code> 不接收任何参数并提供一个结果</p>
<p>在命令式编程中我们可以这样写</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static String getDbConnectionUrl() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return &quot;jdbc://localhost:5432/users&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(getDbConnectionUrl());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>函数式编程的版本</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static Supplier&lt;String&gt; getDbConnectionUrlSupplier = () -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;jdbc://localhost:5432/users&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static Supplier&lt;List&lt;String&gt;&gt; getDbConnectionListUrlSupplier = () -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;jdbc://localhost:5432/users&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;jdbc://localhost:5432/customer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(getDbConnectionUrlSupplier.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(getDbConnectionListUrlSupplier.get());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>完整代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class _Supplier {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(getDbConnectionUrl());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(getDbConnectionUrlSupplier.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(getDbConnectionListUrlSupplier.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static String getDbConnectionUrl() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;jdbc://localhost:5432/users&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static Supplier&lt;String&gt; getDbConnectionUrlSupplier = () -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;jdbc://localhost:5432/users&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static Supplier&lt;List&lt;String&gt;&gt; getDbConnectionListUrlSupplier = () -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;jdbc://localhost:5432/users&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;jdbc://localhost:5432/customer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="stream">Stream<a href="#stream" class="hash-link" aria-label="Stream的直接链接" title="Stream的直接链接">​</a></h2>
<p>首先将前文的定义 Persion 的代码复制过来</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private record Person(String name, Gender gender) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enum Gender {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MALE, FEMALE, PREFER_NOT_TO_SAY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;Person&gt; people = List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;John&quot;, MALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Maria&quot;, FEMALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Aisha&quot;, FEMALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Alex&quot;, MALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Alice&quot;, FEMALE),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Person(&quot;Bob&quot;, PREFER_NOT_TO_SAY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过 Stream 来调用</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">people.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(Person::name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .mapToInt(String::length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//        .collect(Collectors.toSet())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .forEach(System.out::println);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以把每一步的参数提取成变量，方便观察它们的类型</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Function&lt;Person, String&gt; personStringFunction = Person::name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ToIntFunction&lt;String&gt; length = String::length;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IntConsumer println = System.out::println;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        people.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(personStringFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .mapToInt(length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//                .collect(Collectors.toSet())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(println);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Stream 的其他用法</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Predicate&lt;Person&gt; personPredicate = person -&gt; FEMALE.equals(person.gender);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var containOnlyFemales = people.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .allMatch(personPredicate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(containOnlyFemales);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var personHaveFemales = people.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .anyMatch(personPredicate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//      .noneMatch(personPredicate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(personHaveFemales);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optional">Optional<a href="#optional" class="hash-link" aria-label="Optional的直接链接" title="Optional的直接链接">​</a></h2>
<p><code>Optional</code> 会改变你处理空指针的方式</p>
<p>示例：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var value = Optional.ofNullable(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElseGet(() -&gt; &quot;default value&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var value2 = Optional.ofNullable(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElseGet(() -&gt; &quot;default value&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>示例2：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Supplier&lt;IllegalStateException&gt; exception = () -&gt; new IllegalStateException(&quot;exception&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var value3 = Optional.ofNullable(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElseThrow(exception);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>示例3：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(&quot;john.gmail.com&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ifPresent(email -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println(&quot;Sending email to &quot; + email));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ifPresentOrElse(email -&gt; System.out.println(&quot;Sending email to &quot; + email),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                () -&gt; System.out.println(&quot;Can not send email&quot;));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>完整代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var value = Optional.ofNullable(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElseGet(() -&gt; &quot;default value&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var value2 = Optional.ofNullable(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElseGet(() -&gt; &quot;default value&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(value2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Supplier&lt;IllegalStateException&gt; exception = () -&gt; new IllegalStateException(&quot;exception&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var value3 = Optional.ofNullable(&quot;hello&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElseThrow(exception);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(&quot;john.gmail.com&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(email -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        System.out.println(&quot;Sending email to &quot; + email));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresentOrElse(email -&gt; System.out.println(&quot;Sending email to &quot; + email),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        () -&gt; System.out.println(&quot;Can not send email&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="combinator-pattern">Combinator Pattern<a href="#combinator-pattern" class="hash-link" aria-label="Combinator Pattern的直接链接" title="Combinator Pattern的直接链接">​</a></h2>
<p>我们有一个 Customer 类定义如下</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public record Customer(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String email,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String phoneNumber,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocalDate dob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Customer customer = new Customer(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;Alice&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;alice@gmail.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;+089998879&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocalDate.of(2000, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们想验证此人的信息是否合法。在命令式编程中，我们可以这样验证</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomerValidatorService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isEmailValid(String email) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return email.contains(&quot;@&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isPhoneNumberValid(String phoneNumber) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return phoneNumber.startsWith(&quot;+0&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isAdult(LocalDate dob) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Period.between(dob, LocalDate.now()).getYears() &gt; 16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isValid(Customer customer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isEmailValid(customer.email())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; isPhoneNumberValid(customer.phoneNumber())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; isAdult(customer.dob());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---usage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(new CustomerValidatorService().isValid(customer));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，当我们需要添加验证项或者需要根据不同的用户启用不同的验证策略时，上面的方法需要改动太多的代码。这种方法的另一个缺点是：当验证失败时，我们无法知道对象的哪个属性没有通过验证，该方法只是返回一个失败的结果，这个结果并不包含细节。</p>
<p>我这里介绍的解决方案叫做 Combinator Pattern</p>
<p>为了能够返回方法的详细信息，我们首先定义一个枚举类</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enum ValidationResult {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SUCCESS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PHONE_NUMBER_NOT_VALID,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EMAIL_NOT_VALID,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IS_NOT_AN_ADULT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们使用 <code>CustomerRegistrationValidator interface</code> 扩展 <code>Functional interface</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface CustomerRegistrationValidator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extends Function&lt;Customer, ValidationResult&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator isEmailValid() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt; customer.email().contains(&quot;@&quot;) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SUCCESS : EMAIL_NOT_VALID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator isPhoneNumberValid() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt; customer.phoneNumber().startsWith(&quot;+0&quot;) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SUCCESS : PHONE_NUMBER_NOT_VALID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator isAnAdult() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Period.between(customer.dob(), LocalDate.now()).getYears() &gt; 16 ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        SUCCESS : IS_NOT_AN_ADULT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * test lazy load</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator printSomething() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;print something&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default CustomerRegistrationValidator and (CustomerRegistrationValidator other) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ValidationResult result = this.apply(customer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result.equals(SUCCESS) ? other.apply(customer) : result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum ValidationResult {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SUCCESS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PHONE_NUMBER_NOT_VALID,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EMAIL_NOT_VALID,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IS_NOT_AN_ADULT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>用法很简单</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var result = isEmailValid()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and(isPhoneNumberValid())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and(isAnAdult())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .apply(customer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (result != ValidationResult.SUCCESS) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new IllegalStateException(result.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用这种方法，我们可以灵活地组合多个验证。当验证失败时，该方法会返回失败的原因</p>
<p>此外，它是延迟加载，也就是直到调用 <code>apply()</code> 时才会真正执行</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var result2 = isEmailValid()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and(isPhoneNumberValid())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and(isAnAdult())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and(printSomething());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(&quot;not load before apply()&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">result2.apply(customer);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>完整代码</p>
<p>调用方法</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Customer customer = new Customer(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Alice&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;alice@gmail.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;+089998879&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                LocalDate.of(2000, 1, 1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(new CustomerValidatorService().isValid(customer));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // If valid we can store customer in db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Using combinator pattern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var result = isEmailValid()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .and(isPhoneNumberValid())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .and(isAnAdult())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .apply(customer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result != ValidationResult.SUCCESS) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(result.name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Lazy lode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var result2 = isEmailValid()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .and(isPhoneNumberValid())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .and(isAnAdult())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .and(printSomething());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;not load before apply()&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result2.apply(customer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>命令式编程</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomerValidatorService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isEmailValid(String email) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return email.contains(&quot;@&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isPhoneNumberValid(String phoneNumber) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return phoneNumber.startsWith(&quot;+0&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isAdult(LocalDate dob) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Period.between(dob, LocalDate.now()).getYears() &gt; 16;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isValid(Customer customer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isEmailValid(customer.email())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; isPhoneNumberValid(customer.phoneNumber())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; isAdult(customer.dob());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>函数式编程</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface CustomerRegistrationValidator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extends Function&lt;Customer, ValidationResult&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator isEmailValid() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt; customer.email().contains(&quot;@&quot;) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SUCCESS : EMAIL_NOT_VALID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator isPhoneNumberValid() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt; customer.phoneNumber().startsWith(&quot;+0&quot;) ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SUCCESS : PHONE_NUMBER_NOT_VALID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator isAnAdult() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Period.between(customer.dob(), LocalDate.now()).getYears() &gt; 16 ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        SUCCESS : IS_NOT_AN_ADULT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * test lazy load</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static CustomerRegistrationValidator printSomething() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;print something&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default CustomerRegistrationValidator and (CustomerRegistrationValidator other) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return customer -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ValidationResult result = this.apply(customer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result.equals(SUCCESS) ? other.apply(customer) : result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enum ValidationResult {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SUCCESS,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PHONE_NUMBER_NOT_VALID,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EMAIL_NOT_VALID,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IS_NOT_AN_ADULT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>entity</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public record Customer(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String email,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String phoneNumber,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LocalDate dob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="callbacks">Callbacks<a href="#callbacks" class="hash-link" aria-label="Callbacks的直接链接" title="Callbacks的直接链接">​</a></h2>
<p>由于 Java 的函数式接口，我们现在可以像 JavaScript 一样使用 callback</p>
<p>在 JavaScript 中，我们像这样定义带有回调的函数</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">firstName</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> lastName</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter">callback</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">firstName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lastName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lastName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">callback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以在 Chrome 控制台中调用它</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;john&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;no lastname provided&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在我们可以在 Java 中做同样的事情</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static void hello(String firstName, String lastName, Consumer&lt;String&gt; callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(firstName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (lastName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(lastName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        callback.accept(firstName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void hello2(String firstName, String lastName, Runnable callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(firstName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (lastName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(lastName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        callback.run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>usage</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">hello(&quot;John&quot;, &quot;Montana&quot;, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello(&quot;John&quot;, null, value -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;no lastName provided for &quot; + value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hello2(&quot;John&quot;, null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        () -&gt; System.out.println(&quot;no lastName provided&quot;));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>完整代码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Callbacks {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hello(&quot;John&quot;, &quot;Montana&quot;, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hello(&quot;John&quot;, null, value -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;no lastName provided for &quot; + value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hello2(&quot;John&quot;, null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                () -&gt; System.out.println(&quot;no lastName provided&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void hello(String firstName, String lastName, Consumer&lt;String&gt; callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(firstName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (lastName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(lastName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.accept(firstName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void hello2(String firstName, String lastName, Runnable callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(firstName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (lastName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(lastName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback.run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Callback function in js:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    function hello(firstName, lastName,callback) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        console.log(firstName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (lastName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            console.log(lastName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Invoke it:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hello(&quot;john&quot;, null, function(){console.log(&quot;no lastname provided&quot;)})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复  制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="函数式编程的特性">函数式编程的特性<a href="#函数式编程的特性" class="hash-link" aria-label="函数式编程的特性的直接链接" title="函数式编程的特性的直接链接">​</a></h2>
<ul>
<li>无状态</li>
<li>纯函数</li>
<li>无副作用</li>
<li>高阶特性<!-- -->
<ul>
<li>函数将一个或多个函数作为参数。</li>
<li>函数返回另一个函数作为结果。</li>
</ul>
</li>
</ul></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="跟着我体验一下传说中非常厉害的类加载器吧！"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/custom-class-loader-loads-encrypted-class-file">自定义 ClassLoader 加载一个加密 class 文件</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-03-05T00:00:00.000Z" itemprop="datePublished">2021年3月5日</time> · <!-- -->阅读需 5 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>跟着我体验一下传说中非常厉害的类加载器吧！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="制作加密-class">制作加密 class<a href="#制作加密-class" class="hash-link" aria-label="制作加密 class的直接链接" title="制作加密 class的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="目标类">目标类<a href="#目标类" class="hash-link" aria-label="目标类的直接链接" title="目标类的直接链接">​</a></h3>
<p>我们要加载的类很简单，它只有一个 <code>hello()</code> 方法。编译这个类生成 class 文件，待会要用</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package ClassLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Hello {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void hello(){ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Hello, classLoader!&quot;); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="加密">加密<a href="#加密" class="hash-link" aria-label="加密的直接链接" title="加密的直接链接">​</a></h3>
<p>下面这段代码读取了刚才生成的 Hello.class ，加密之后保存为 Hello.xlass</p>
<p><code>encode()</code> 实现了一个简单的加密，加载类的时候使用同样的方法就可以解密</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package ClassLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.File;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.FileInputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.FileOutputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author : solidSpoon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date : 2021/3/5 1:57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EncodeFile {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String name = &quot;Hello&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        EncodeFile ef = new EncodeFile();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] fileByteArray = ef.loadFile(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fileByteArray = ef.encode(fileByteArray);;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ef.storeFile(fileByteArray, name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public byte[] loadFile(String name){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        File f = new File(this.getClass().getResource(name + &quot;.class&quot;).getPath());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] fileByteArray = new byte[(int)f.length()];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new FileInputStream(f).read(fileByteArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fileByteArray;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void storeFile(byte[] fileByteArray, String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String p = this.getClass().getResource(&quot;&quot;).getPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        File file = new File(p + &quot;/&quot; + name + &quot;.xlass&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (FileOutputStream fop = new FileOutputStream(file)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!file.exists()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                file.createNewFile();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fop.write(fileByteArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fop.flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public byte[] encode (byte[] fileToEncode){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(int i=0; i&lt; fileToEncode.length; i++){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fileToEncode[i] = (byte) (255 - fileToEncode[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fileToEncode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="加载">加载<a href="#加载" class="hash-link" aria-label="加载的直接链接" title="加载的直接链接">​</a></h2>
<p>接下来我们定义自己的加载器，把刚才的 xlass 文件解密之后加载到 JVM 中，并反射运行它的 <code>hello()</code> 方法。</p>
<p>具体方法是继承 <code>ClassLoader</code> 类，覆盖它的 <code>findClass()</code> 方法，在该方法中使用 <code>defineClass()</code> 将字节流转成 <code>Class</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package ClassLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.File;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.FileInputStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.lang.reflect.Method;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author : solidSpoon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @date : 2021/3/5 1:30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyClassLoader extends ClassLoader{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Class&lt;?&gt; clazz = new  MyClassLoader().findClass(&quot;Hello&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object obj = clazz.getConstructor().newInstance();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Method method = clazz.getMethod(&quot;hello&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            method.invoke(obj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        File f = new File(this.getClass().getResource(name + &quot;.xlass&quot;).getPath());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] fileByteArray = new byte[(int)f.length()];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new FileInputStream(f).read(fileByteArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fileByteArray = decode(fileByteArray);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pack = this.getClass().getPackage().getName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return defineClass(pack + &quot;.&quot; + name, fileByteArray, 0, fileByteArray.length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 将编码过的字节数组解码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param fileToDecode 要解码的字节数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 解码的字节数组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public byte[] decode (byte[] fileToDecode){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for(int i=0; i&lt; fileToDecode.length; i++){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fileToDecode[i] = (byte) (255 - fileToDecode[i]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return fileToDecode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="运行结果">运行结果<a href="#运行结果" class="hash-link" aria-label="运行结果的直接  链接" title="运行结果的直接链接">​</a></h2>
<p>我们的类加载器解密了 xlass 并将它加载到了 JVM 中</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Hello, classLoader!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="原理">原理<a href="#原理" class="hash-link" aria-label="原理的直接链接" title="原理的直接链接">​</a></h2>
<p>类加载的原则是双亲委派模型：如果一个类加载器收到了类加载的请求，它首先会把这个请求委派给父类加载器去完成，每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到最顶层的启动类加载器中，只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去完成加载。</p>
<p>我们定义的这个 <code>findClass()</code> 方法会在下面这个地方调用，如代码所示，如果该类还没有被加载并且父加载器无法加载个类（当然肯定不能加载），就会调用我们定  义的 <code>findClass()</code> 去加载这个类</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// java.lang ClassLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws ClassNotFoundException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (getClassLoadingLock(name)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // First, check if the class has already been loaded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Class&lt;?&gt; c = findLoadedClass(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (c == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long t0 = System.nanoTime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (parent != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        c = parent.loadClass(name, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        c = findBootstrapClassOrNull(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (ClassNotFoundException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ClassNotFoundException thrown if class not found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // from the non-null parent class loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (c == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If still not found, then invoke findClass in order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // to find the class.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    long t1 = System.nanoTime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    c = findClass(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // this is the defining class loader; record the stats</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    PerfCounter.getFindClasses().increment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (resolve) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                resolveClass(c);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return c;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">Java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/jvm">JVM</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/类加载器">类加载器</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="想要读懂 Java 的字节码其实没那么难。当然，如果你有汇编语言的经验就会更好上手。本文手把手教你阅读一个简单 Java 文件的字节码。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/step-by-step-guide-to-reading-bytecode-of-a-java-file">手把手教你读一个 Java 文件的字节码</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-03-04T00:00:00.000Z" itemprop="datePublished">2021年3月4日</time> · <!-- -->阅读需 8 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>想要读懂 Java 的字节码其实没那么难。当然，如果你有汇编语言的经验就会更好上手。本文手把手教你阅读一个简单 Java 文件的字节码。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何得到字节码">如何得到字节码？<a href="#如何得到字节码" class="hash-link" aria-label="如何得到字节码？的直接链接" title="如何得到字节码？的直接链接">​</a></h2>
<p>以下面这段示例代码为例，他存放在一个包中：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package demo.a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class B{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过下面这几个方法就可以查看代码的字节码：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="方法-1-命令行">方法 1 、命令行<a href="#方法-1-命令行" class="hash-link" aria-label="方法 1 、命令行的直接链接" title="方法 1 、命令行的直接链接">​</a></h3>
<p>相关命令如下</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">javac demo/a/B.java // 编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jvavp -c demo.a.B   // 输出字节码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">javap -c -verbose demo.a.B // 详细输出</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="方法-2-idea-插件">方法 2 、idea 插件<a href="#方法-2-idea-插件" class="hash-link" aria-label="方法 2 、idea 插件的直接链接" title="方法 2 、idea 插件的直接链接">​</a></h3>
<p>下载个插件：「jclasslib Bytecode Viewer」，网址如下</p>
<blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/9248-jclasslib-bytecode-viewer" target="_blank" rel="noopener noreferrer">https://plugins.jetbrains.com/plugin/9248-jclasslib-bytecode-viewer</a></p>
</blockquote>
<p>安装该插件后，首先编译代码，然后
菜单 👉 「view」 👉 「Show Bytecode With jclasslib」
结果如下：
<img loading="lazy" src="https://ced-md-picture.oss-cn-beijing.aliyuncs.com/img/20210402103711.png" alt="" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="实验代码">实验代码<a href="#实验代码" class="hash-link" aria-label="实验代码的直接链接" title="实验代码的直接链接">​</a></h2>
<p>我们使用下面这段代码，你可以将其输入 IDE 中</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Hello {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num1 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num2 = 130;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num3 = num1 + num2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num4 = num2 - num1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num5 = num1 * num2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num6 = num2 / num1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int num7 = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer num88 = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //看装箱指令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(num88 == 0){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Integer&gt; nums = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nums.add(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nums.add(2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int num : nums){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nums.size() == num2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面是由 idea 反编译得到的代码，可以观察到 <code>for</code> 循环被改成了 <code>while</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Source code recreated from a .class file by IntelliJ IDEA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// (powered by FernFlower decompiler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Iterator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Hello {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Hello() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num1 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num2 = 130;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int var10000 = num1 + num2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var10000 = num2 - num1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var10000 = num1 * num2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var10000 = num2 / num1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num7 = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer num88 = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (num88 == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Integer&gt; nums = new ArrayList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nums.add(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nums.add(2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Iterator var10 = nums.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while(var10.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int num = (Integer)var10.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nums.size() == num2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="阅读字节码">阅读字节码<a href="#阅读字节码" class="hash-link" aria-label="阅读字节码的直接链接" title="阅读字节码的直接链接">​</a></h2>
<p>为了方便解释，我将字节码文件拆成小段，首先使用下面这个命令输出字节码</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\cedar\Desktop\ReadBytecode\code\target\classes&gt; javap -c .\Hello.class</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一开始就说明了这是「Hello.java」的字节码</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Compiled from &quot;Hello.java&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Hello {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>紧接着自动创建了无参构造方法，调用了父类 <code>Object</code> 的初始化函数。 <code>aload_0</code> 是说把本地变亮表位置 0 的对象加载出来，而这个位置保存的是对自身的引用。</p>
<p>你会发现字节码每条命令前面也有一个数字，比如 <code>0: aload_0</code> 前面有一个 <code>0</code> ，它代表 <code>aload_0</code> 这条指令在第 0 个位置。接着观察 <code>4: return</code>，它的位置怎么突然变成 4 了？那是因为 <code>invokespecial</code> 这个指令还有两个输入参数，一共占用三个字节</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- 字节码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public Hello();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Code:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       0: aload_0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       4: return</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>1: invokespecial #1</code> 的 <code>#1</code>，代表常量池位置 1.常量池通过 <code>javap -c -verbose demo.a.B</code> 就可以显示出来，如下所示</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Constant pool:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   #1 = Methodref          #15.#48        // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   #2 = Methodref          #12.#49        // java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   #3 = Methodref          #12.#50        // java/lang/Integer.intValue:()I</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来就是 <code>main</code> 方法了，还记得我们在 <code>main</code> 方法中干了什么吗</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num1 = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num2 = 130;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num3 = num1 + num2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num4 = num2 - num1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num5 = num1 * num2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num6 = num2 / num1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int num7 = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer num88 = 6;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>它对应的字节码是下面这样的，具体内容我已经标注出来了，稍微解释一下 <code>iconst_1</code> ，代表常量 <code>int 1</code> ，也就是代码中有个常量 「1」加载到栈顶</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  public static void main(java.lang.String[]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Code:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 初始化 num1 = 1;保存到变量表 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       0: iconst_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       1: istore_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 初始化 num2 = 130; 保存到 变量表2，以下同理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       2: sipush        130</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       5: istore_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 计算 num3(匿名了) = num1 + num2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       6: iload_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       7: iload_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       8: iadd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       9: istore_3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 计算 num4(匿名了) = num2 - num1;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      10: iload_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      11: iload_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      12: isub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      13: istore        4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 计算 num5(匿名了) = num1 * num2; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      15: iload_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      16: iload_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      17: imul</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      18: istore        5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 计算 num6(匿名了) = num2 / num1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      20: iload_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      21: iload_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      22: idiv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      23: istore        6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- final int num7 = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      25: iconst_5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      26: istore        7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- Integer num88 = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      28: bipush        6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      30: invokestatic  #2                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      33: astore        8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后是这个 <code>if</code> 语句</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        if (num88 == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意上文 <code>num88</code> 被保存到变量表位置 8，所以此处把位置 8 加载出来</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- 字节码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      35: aload         8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      37: invokevirtual #3                  // Method java/lang/Integer.intValue:()I</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      40: ifne          50 -- 如果不等于 0 就跳转到 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      43: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      46: iload_1          -- 存储 num1 的地方</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      47: invokevirtual #5                  // Method java/io/PrintStream.println:(I)V</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后我们操作了一个 <code>List</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Integer&gt; nums = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nums.add(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        nums.add(2);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -- 初始化 List 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      50: new           #6                  // class java/util/ArrayList</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      53: dup              -- 把栈顶的值复制一份再压回去，此时栈顶有两份一样的值，分别被 54 和 57 指令消耗了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      54: invokespecial #7                  // Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      57: astore        9 -- 将初始化的对象存到寄存器 9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- list -&gt; add(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      59: aload         9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      61: iconst_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      62: invokestatic  #2                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      65: invokeinterface #8,  2            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      70: pop           -- 丢弃了 add 返回值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- list -&gt; add(2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      71: aload         9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      73: iconst_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      74: invokestatic  #2                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      77: invokeinterface #8,  2            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      82: pop           -- 丢弃了 add 返回值</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>遍历 <code>List</code> ，这里 JVM 把 <code>for</code> 改成了 <code>while</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 源代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int num : nums){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(num);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//被 JVM 该成如下代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Iterator var10 = nums.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while(var11.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int num = (Integer)var11.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(num);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -- 获取迭代器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      83: aload         9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      85: invokeinterface #9,  1            // InterfaceMethod java/util/List.iterator:()Ljava/util/Iterator;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      90: astore        10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      92: aload         10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      94: invokeinterface #10,  1           // InterfaceMethod java/util/Iterator.hasNext:()Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      99: ifeq          128 -- 如果等于 0，跳转到 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -- 获取 next() 并打印</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     102: aload         10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     104: invokeinterface #11,  1           // InterfaceMethod java/util/Iterator.next:()Ljava/lang/Object;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     109: checkcast     #12                 // class java/lang/Integer  -- 检查对象是否为给定类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     112: invokevirtual #3                  // Method java/lang/Integer.intValue:()I</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     115: istore        11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     117: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     120: iload         11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     122: invokevirtual #5                  // Method java/io/PrintStream.println:(I)V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     125: goto          92</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后我们写了个 if</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 源码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nums.size() == num2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(num2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -- 如果 list.size() == num2; 打印 num2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     128: aload         9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     130: invokeinterface #13,  1           // InterfaceMethod java/util/List.size:()I</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     135: iload_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     136: if_icmpne     146</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     139: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     142: iload_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     143: invokevirtual #5                  // Method java/io/PrintStream.println:(I)V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     146: return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="小结">小结<a href="#小结" class="hash-link" aria-label="小结的直接链接" title="小结的直接链接">​</a></h2>
<p>Java 的字节码还是要比汇编简单一些。</p>
<p>这里再提一点，当要初始化一个 int 时（在 JVM 中：bool，byte，char，short 都是 int），根据不同的数字所占的位数不同，分别需要如下几个命令，方括号中给出了命令适用的范围</p>
<ul>
<li>iconst: [-1, 5]</li>
<li>bipush: [-128, 127]</li>
<li>sipush: [-32768, 32767]</li>
<li>idc: any int value</li>
</ul>
<hr>
<ul>
<li><a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html" target="_blank" rel="noopener noreferrer">https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/字节码">字节码</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">Java</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="初识 JShell"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/getting-started-with-jshell">初识 JShell</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-02-23T00:00:00.000Z" itemprop="datePublished">2021年2月23日</time> · <!-- -->阅读需 4 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="初识-jshell">初识 JShell<a href="#初识-jshell" class="hash-link" aria-label="初识 JShell的直接链接" title="初识 JShell的直接链接">​</a></h2>
<p>升级到 Java 11 后，有了 JShell 这个工具（其实 Java 9 就有了），它让 Java 可以像脚本语言一样直接在命令行交互，听起来好神奇，快来体验一下！！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启动与退出">启动与退出<a href="#启动与退出" class="hash-link" aria-label="启动与退出的直接链接" title="启动与退出的直接链接">​</a></h2>
<p>保险起见，得先弄明白启动与退出</p>
<p>直接在命令行输入 <code>jshell</code> 就启动了</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">➜  ~cedar jshell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Welcome to JShell -- Version 11.0.9.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  For an introduction type: /help intro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>退出方式稍微有一些特别，命令是 <code>/exit</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /exit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Goodbye</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>jshell -h</code> 可以发现提供了几个选项，这仨比较有意思</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    -q                    Quiet feedback.  Same as: --feedback concise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -s                    Really quiet feedback.  Same as: --feedback silent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -v                    Verbose feedback.  Same as: --feedback verbose</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>试了一下 <code>-s</code> 非常安静的反馈，看起来真的清爽</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">➜  ~cedar jshell -s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-&gt; int a = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-&gt; int b = 2;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>初学者还是别整这么安静了，使用 <code>-v</code> 开启详细反馈吧</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">➜  ~cedar jshell -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  Welcome to JShell -- Version 11.0.9.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  For an introduction type: /help intro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="简单使用">简单使用<a href="#简单使用" class="hash-link" aria-label="简单使用的直接链接" title="简单使用的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="变量赋值">变量赋值<a href="#变量赋值" class="hash-link" aria-label="变量赋值的直接链接" title="变量赋值的直接链接">​</a></h3>
<p>赋几个值看看</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; int a = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a ==&gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  created variable a : int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; a + 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$2 ==&gt; 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  created scratch variable $2 : int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; $2 + a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$3 ==&gt; 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  created scratch variable $3 : int</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可见：没有指定变量的数字会自动赋值给临时变量，我们也可以使用这个临时变量</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="方法与类">方法与类<a href="#方法与类" class="hash-link" aria-label="方法与类的直接链接" title="方法与类的直接链接">​</a></h3>
<p>那创建方法呢？</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; String addMark(Word word) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...&gt; return word.val + &quot;!&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...&gt; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  created method addMark(Word), however, it cannot be referenced until class Word is declared</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里方法传入了一个不存在的类，他告诉我们要定义这个类才能使用这个方法，那定义一下吧</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; class Word {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...&gt; String val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...&gt; public Word() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...&gt; val = &quot;hello word&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...&gt; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ...&gt; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  created class Word</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    update replaced method addMark(Word)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建个对象调用一下</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; Word words = new Word()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">words ==&gt; Word@2ef1e4fa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  created variable words : Word</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; addMark(words)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$4 ==&gt; &quot;hello word!&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  created scratch variable $4 : String</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="内置命令">内置命令<a href="#内置命令" class="hash-link" aria-label="内置命令的直接链接" title="内置命令的直接链接">​</a></h3>
<p>输入 <code>/help</code> 就能看到所有可以使用的命令，例如列出所有变量</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /vars</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    Word words = Word@2ef1e4fa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    String $4 = &quot;hello word!&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="外部编辑器">外部编辑器<a href="#外部编辑器" class="hash-link" aria-label="外部编辑器的直接链接" title="外部编辑器的直接链接">​</a></h2>
<p>有没有觉得在命令行定义类或者方法啥的太费事了，其实 JShell 支持使用编辑器</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用默认编辑器">使用默认编辑器<a href="#使用默认编辑器" class="hash-link" aria-label="使用默认编辑器的直接链接" title="使用默认编辑器的直接链接">​</a></h3>
<p>先定义一个类</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; class Friend{}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  已创建 类 Friend</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>调用自带的编辑器</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /edit Friend</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如下图，点击 Accept 就行</p>
<p><img loading="lazy" src="https://ced-md-picture.oss-cn-beijing.aliyuncs.com/img/20210223013703.png" alt="img" class="img_ev3q"></p>
<p>注意一定是之前定义好的片段，如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1 : int a = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2 : int b = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   3 : int c = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   6 : class Friend{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       String val = &quot;No Friend !!!&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>否则会报错</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /edit Dog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  没有此类片段: Dog</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义编辑器">自定义编辑器<a href="#自定义编辑器" class="hash-link" aria-label="自定义编辑器的直接链接" title="自定义编辑器的直接链接">​</a></h3>
<p>如果想自定义编辑器呢，自带的太不好用</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /set editor vim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  编辑器设置为: vim</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /set editor &quot;C:\\Users\\cedar\\AppData\\Local\\Programs\\Microsoft VS Code\\code&quot; -w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|  编辑器设置为: C:\Users\cedar\AppData\Local\Programs\Microsoft VS Code\code -w</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该 <code>-w</code> 选项设置等待文件关闭后再返回</p>
<p>上述设置是一次性的，想永久设置的话，使用 <code>-retain</code> 选项</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">jshell&gt; /set editor -retain vim</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">Java</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="樱花烂漫时节，一身利落的轻装，踏着新发的嫩草，悠悠的散步。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/an-essay">一篇散文</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-02-16T00:00:00.000Z" itemprop="datePublished">2021年2月16日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>樱花烂漫时节，一身利落的轻装，踏着新发的嫩草，悠悠的散步。</p>
<p>不知方向，不知目标，就只是静静的，慢慢的体会生活的美好，感悟生命的意义。听过一句话:人生总是太匆忙。的确，忙忙碌碌中，我们忽视了很多生活的美好。</p>
<p>草长莺飞,万物轮回。时间一点一滴，带走了我们的年少时光，回顾往昔，我们拥有什么?我们曾经拥有什么?跌跌撞撞的小学生活，恍恍惚惚的初中时代，坎坎坷坷的高 中炼狱，仿佛都成为了泡沫，在阳光下消弭。现在的现在，我们拥有的只有当下。</p>
<p>如今，最重要的是梦想，是志向。很多人为了这些行走匆忙，但忽视了周围的风景。春意盎然，阳光微煦，微风轻暖。此时，踏一席春色，享无边烂漫。就像顾城说的那样:草在结它的种子，风在摇它的叶子。我们站着，不说话，就很美好。</p>
<p>这样单纯的美好，值得每个人记住。那么，在疾走的时候，为什么不停下来看看呢?在砥砺前行的同时，注意到周围的芬芳，人生会更加无憾。
所以，奔赴远方的少年啊，请在追寻未来的同时，把握住现在。你实现梦想的未来是很美好，但载歌载舞的如今，同样值得依恋。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="我们日常看文章的时候，其实已经在慢慢积累我们的审美意识，我们能分辨，哪篇推文看着舒服，哪篇文章看着辣眼睛。为了减少这种「辣眼睛」的情况出现，今天我就来谈谈关于文章排版的事情。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/article-formatting-guide">文章排版指南</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-02-16T00:00:00.000Z" itemprop="datePublished">2021年2月16日</time> · <!-- -->阅读需 10 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><blockquote>
<p>我们日常看文章的时候，其实已经在慢慢积累我们的审美意识，我们能分辨，哪篇推文看着舒服，哪篇文章看着辣眼睛。为了减少这种「辣眼睛」的情况出现，今天我就来谈谈关于文章排版的事情。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="博客排版">▎博客排版<a href="#博客排版" class="hash-link" aria-label="▎博客排版的直接链接" title="▎博客排版的直接链接">​</a></h3>
<p>写博客的同学都知道，现在博客都是由 Markdown 排版。如果你还不知到 Markdown 的话就去学习一下吧，它可以很方便地帮助我们排版出漂亮的文章。但我们在写博文的时候，仍有一些细节是需要注意的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-空格">1. 空格<a href="#1-空格" class="hash-link" aria-label="1. 空格的直接链接" title="1. 空格的直接链接">​</a></h4>
<p>每次看到网页上的中文字和英文、数字、符号挤在一起，就会坐立不安，忍不住想在他们之间加个空格。</p>
<ul>
<li>
<p>中英文之间需要加空格</p>
<p><em>eg</em>. 大家可以微信搜一搜 solidSpoon 关注我。</p>
</li>
<li>
<p>中文与数字之间需要加空格</p>
<p><em>eg</em>. 不知不觉，我已经写博客 3 个月了。</p>
</li>
<li>
<p>数字与单位之间需要加空格</p>
<p><em>eg</em>. 我昨天买了一个 16 GB 的 U 盘。</p>
</li>
<li>
<p>完整的英文整句时标点后要加空格。</p>
<p><em>eg</em>. Love me, love my dog.</p>
</li>
</ul>
<p><strong>但是也有一些例外。</strong></p>
<ul>
<li>
<p>度的标志、百分号不加空格</p>
<p><em>eg</em>. 水的沸点是 100 °。</p>
<p><em>eg</em>. 我的手机还有 75％ 的电量。</p>
</li>
<li>
<p>全角标点与其他字符之间不加空格</p>
<p><em>eg</em>. 大家好，我是 solidSpoon，欢迎访问我的博客。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-标点">2. 标点<a href="#2-标点" class="hash-link" aria-label="2. 标点的直接链接" title="2. 标点的直接链接">​</a></h4>
<p>说到标点，不得不说下全角和半角，很多人可能不了解全角和半角的概念，这里顺便介绍下。</p>
<p>全角和半角是英文和中文的编码规范不同遗留下的问题，简单来说，全角占两个字节，半角占一个字节，你可以理解成中文汉子是全角，英文字母是半角，不过半角全角主要是针对标点符号来说的，中文标点占两个字节，英文标点占一个字节。体现在排版上的差异就是，全角字符屏幕打印宽度是两个，而半角字符屏幕打印宽度是一个，如中文逗号和英文逗号他们的显示分别是「，」和「,」。</p>
<ul>
<li>
<p>使用全角中文标点</p>
<p>中文排版中所有的标点都应该使用中文全角中文标点</p>
<p><em>eg</em>. 大家好，我是 solidSpoon。</p>
</li>
<li>
<p>遇到英文整句、特殊名词时使用半角标点。</p>
<p><em>eg</em>. 乔布斯说过：「Stay hungry, stay foolish.」</p>
<p><em>eg</em>. Facebook, Inc.</p>
</li>
<li>
<p>使用直角引号</p>
<ul>
<li>
<p>我国国家标准要求弯引号，但是个人建议在新媒体排版时使用直角引号。</p>
<p><em>eg</em>. 「我去吃饭了」，它起身说到。</p>
</li>
<li>
<p>如果引号再使用引号使用直角双引号。</p>
<p><em>eg</em>. 我对他说：「乔布斯说过：『Stay hungry, stay follish.』」</p>
</li>
</ul>
</li>
</ul>
<p><strong>微软拼音输入特殊符号方法：</strong></p>
<p>首先在中文输入界面输入 <code>u</code> 进入「u 模式输入」，然后跟着屏幕提示就可以找到你要输入的特殊符号了。</p>
<ul>
<li><em>eg</em>. 中文界面输入 <code>uubd</code> 就可以找到直角引号。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-其他">3. 其他<a href="#3-其他" class="hash-link" aria-label="3. 其他的直接链接" title="3. 其他的直接链接">​</a></h4>
<p>除以上之外，还有一些其他标准推荐大家使用的。</p>
<ul>
<li>
<p>英文名词首字母尽量大写</p>
<p>eg. Google、Android、Facebook</p>
</li>
<li>
<p>专有名词使用正确的大小写</p>
<p>eg. GitHub、iOS、iPhone XS Max、MacBook Pro</p>
</li>
<li>
<p>首行不要缩进</p>
</li>
</ul>
<p>关于首行不缩进可能有人不太同意，但是我要在这里解释下，在说明之前我们必须弄明白「首行缩进」的目的是什么。</p>
<p>「每段之前空两格」是我们从小学写作文就养成的习惯，也是正式文体的格式要求，其目的是为了区分自然段。</p>
<p>但是像我们现在接触的阅读，都是没有固定的格式要求的，如微信公众号、电子文档等，所以大家一般都采用「空出一行」进行自然段与自然段之间的区分，这种写作方式非常省事，而且很整齐。</p>
<p>所以，我认为这种应该是最科学的方式，只要没有明确的格式要求，写作的排版无须首行缩进。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="公众号排版">▎公众号排版<a href="#公众号排版" class="hash-link" aria-label="▎公众号排版的直接链接" title="▎公众号排版的直接链接">​</a></h3>
<p>用 Markdown 写作的确很方便。那么对于「不那么方便」的微信公众号，除了上面的那些外，又有什么是需要注意的呢？</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-大小">1. 大小<a href="#1-大小" class="hash-link" aria-label="1. 大小的直接链接" title="1. 大小的直接链接">​</a></h4>
<p>简单来说就是：标题要比正文大，正文要比标注大。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-颜色">2. 颜色<a href="#2-颜色" class="hash-link" aria-label="2. 颜色的直接链接" title="2. 颜色的直接链接">​</a></h4>
<p>颜色搭配保持统一，个别字体使用特殊色强调，字体颜色尽量不超过三种，颜色不要选取太亮的颜色，例如纯黑，纯红，亮红配亮绿，都是不建议的，看久了眼睛难免会疲惫，不利于阅读。</p>
<p><strong>建议使用字体颜色：</strong></p>
<ul>
<li>标题：使用公众号常用色，或者直接取 logo 或者行业色</li>
<li>正文：选择亮度没这么高的字体，这是纯黑 <code>#000000</code> ，比较偏灰会更加适合阅读 <code>#595757</code> <code>#3f3f3f</code> 等</li>
<li>批注：选择比正文亮度还低，更加浅的浅灰色，例如 <code>#595959</code> <code>#888888</code> <code>#d6d6d6</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-形态">3. 形态<a href="#3-形态" class="hash-link" aria-label="3. 形态的直接链接" title="3. 形态的直接链接">​</a></h4>
<p>和 word 编辑一样，公众号文字形态也可以做一些基本变化，例如 <strong>加粗</strong>、<em>斜体</em>、<u>下划线</u>、<del>删除线</del> 等，常用的是加粗，以及有趣（戏多）的删除线。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-对齐">4. 对齐<a href="#4-对齐" class="hash-link" aria-label="4. 对齐的直接链接" title="4. 对齐的直接链接">​</a></h4>
<p>对齐，可以说是拯救强迫症的最佳设置。这里推荐对齐方式为：<strong>两端对齐</strong>。</p>
<p>我们日常排版完会发现，因为句子的字符大小的原因，每行的最右边都会变得层次不齐，强迫症看着会非常的不舒服，这时候如果我们选择两端对齐，就会美观的多。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-小符号">5. 小符号<a href="#5-小符号" class="hash-link" aria-label="5. 小符号的直接链接" title="5. 小符号的直接链接">​</a></h4>
<p>就像前面对标题的处理一样，简单的符号也能划分空间，也要常用引号，以此突出重点等</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-留白">6. 留白<a href="#6-留白" class="hash-link" aria-label="6. 留白的直接链接" title="6. 留白的直接链接">​</a></h4>
<p>在经过了文字的排版以后，整个版面的风格已经出来了，但是我们会发现，推文里字句的间距太密了，看久了眼睛很不舒服。其实，这都是因为：<u>没有留白，没有呼吸感</u>。</p>
<p>留白可以包括：</p>
<ul>
<li>页面边距</li>
<li>段 / 字 / 行间距</li>
<li>缩进</li>
<li>空行</li>
</ul>
<p><strong>页面边距</strong></p>
<p>页面边距指的是推文与手机屏幕两侧的距离。</p>
<p>默认距离是 0，我们可以设置，让文字离屏幕远一点。我个人建议页边距设置为 0.5，或者 1，比较舒服。</p>
<p><strong>段距</strong></p>
<p>段落与段落之间，图片与文字之间，都可以使用段前距、段后距进行调整距离，当然也可以使用空格代替。</p>
<p><strong>字间距</strong></p>
<p>字体之间的距离太密，容易让人错过重点内容，调整文字间距会有意想不到的效果，呼吸感瞬间有了。和字间距一样，行间距是解放原有行与行之间的重要一步。</p>
<ul>
<li>推荐参数：行间距 1.5 ~ 1.75、字间距 1</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-图片与表情包">7. 图片与表情包<a href="#7-图片与表情包" class="hash-link" aria-label="7. 图片与表情包的直接链接" title="7. 图片与表情包的直接链接">​</a></h4>
<p>适当的图片和表情可以增加阅读的兴趣</p>
<p><strong>浮动设置</strong></p>
<p>有的时候，我们会看到很多公众号通篇都是长图，而我们上传多图的时候，要么是图片太大上传不了，要么就是多图的时候出现空隙。这时候我们就只要让图片浮动就可以解决这个问题。</p></div><footer class="row docusaurus-mt-lg"></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="你是不是也一直觉得 OneNote、印象笔记、有道云笔记等等工具用起来都有一点不太舒服。我只想用一个简单方便，到哪都能用的笔记系统，但是市面上常见的笔记软件越来越臃肿，小众良心的软件又担心它会不会死掉，这里我给你提供一个思路。"><header><h2 class="title_f1Hy" itemprop="headline"><a itemprop="url" href="/blog/building-a-simple-and-user-friendly-note-taking-system">搭建简单好用的笔记系统</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-02-16T00:00:00.000Z" itemprop="datePublished">2021年2月16日</time> · <!-- -->阅读需 2 分钟</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/solidSpoon.png" alt="solidSpoon" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/solidSpoon" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">solidSpoon</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of Hide</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>你是不是也一直觉得 OneNote、印象笔记、有道云笔记等等工具用起来都有一点不太舒服。我只想用一个简单方便，到哪都能用的笔记系统，但是市面上常见的笔记软件越来越臃肿，小众良心的软件又担心它会不会死掉，这里我给你提供一个思路。</p>
<p>如果你想要一个全平台通用的、适合记笔记的文件格式  ，那么 Markdown 应该是一个不错的选择。Markdown 的语法简单、排版漂亮，配合像 Typora 这种优雅的编辑器能够在电脑端实现很棒的体验。</p>
<p>当然，Markdown 也有它的缺点。由于这种文件格式本身并不能保存图片，导致 Markdown 的使用者常常要自己想办法来解决全平台使用图片的问题。其中最省心的办法就是在类似阿里云、腾讯云这样大型的云服务商购买存储服务，配合 PicGo 这种小工具自己搭建一个图床，操作简单而且质量可靠。</p>
<p>更具体的操作方法你可以去搜索『阿里云 图床』这样的关键词。最后，使用坚果云这种全平台可用的同步盘来同步你的 Markdown 笔记。而且坚果云也有 Markdown 小工具，在手机和网页端浏览 Markdown 文件也比较方便。</p>
<p>希望你也喜欢这样的一种解决方案。</p>
<hr>
<p>题图由<a href="https://pixabay.com/zh/users/Monfocus-2516394/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1925752">Monfocus</a>在<a href="https://pixabay.com/zh/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1925752">Pixabay</a>上发布</p>
<p><img loading="lazy" src="https://ced-md-picture.oss-cn-beijing.aliyuncs.com/img/20200524165524.jpg" alt="list-1925752_1920" class="img_ev3q"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/效率">效率</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="博文列表分页导航"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">较旧的博文</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Hide - solidSpoon, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>