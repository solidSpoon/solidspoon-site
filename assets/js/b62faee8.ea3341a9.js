"use strict";(self.webpackChunksolidspoon_site=self.webpackChunksolidspoon_site||[]).push([[6359],{126:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>r,contentTitle:()=>i,default:()=>p,frontMatter:()=>t,metadata:()=>o,toc:()=>c});var l=a(5893),s=a(1151);const t={slug:"custom-class-loader-loads-encrypted-class-file",title:"\u81ea\u5b9a\u4e49 ClassLoader \u52a0\u8f7d\u4e00\u4e2a\u52a0\u5bc6 class \u6587\u4ef6",authors:["solidSpoon"],tags:["Java","JVM","\u7c7b\u52a0\u8f7d\u5668"]},i=void 0,o={permalink:"/blog/custom-class-loader-loads-encrypted-class-file",editUrl:"https://github.com/solidSpoon/solidSpoon.github.io/tree/main/packages/create-docusaurus/templates/shared/blog/2021/03-05-custom-class-loader-loads-encrypted-class-file/index.md",source:"@site/blog/2021/03-05-custom-class-loader-loads-encrypted-class-file/index.md",title:"\u81ea\u5b9a\u4e49 ClassLoader \u52a0\u8f7d\u4e00\u4e2a\u52a0\u5bc6 class \u6587\u4ef6",description:"\u8ddf\u7740\u6211\u4f53\u9a8c\u4e00\u4e0b\u4f20\u8bf4\u4e2d\u975e\u5e38\u5389\u5bb3\u7684\u7c7b\u52a0\u8f7d\u5668\u5427\uff01",date:"2021-03-05T00:00:00.000Z",formattedDate:"2021\u5e743\u67085\u65e5",tags:[{label:"Java",permalink:"/blog/tags/java"},{label:"JVM",permalink:"/blog/tags/jvm"},{label:"\u7c7b\u52a0\u8f7d\u5668",permalink:"/blog/tags/\u7c7b\u52a0\u8f7d\u5668"}],readingTime:4.465,hasTruncateMarker:!1,authors:[{name:"solidSpoon",title:"Maintainer of Hide",url:"https://github.com/solidSpoon",imageURL:"https://github.com/solidSpoon.png",key:"solidSpoon"}],frontMatter:{slug:"custom-class-loader-loads-encrypted-class-file",title:"\u81ea\u5b9a\u4e49 ClassLoader \u52a0\u8f7d\u4e00\u4e2a\u52a0\u5bc6 class \u6587\u4ef6",authors:["solidSpoon"],tags:["Java","JVM","\u7c7b\u52a0\u8f7d\u5668"]},unlisted:!1,prevItem:{title:"Java \u7ebf\u7a0b\u95f4\u534f\u4f5c\u65b9\u6cd5\u603b\u7ed3",permalink:"/blog/summary-of-thread-collaboration-methods-in-java"},nextItem:{title:"\u624b\u628a\u624b\u6559\u4f60\u8bfb\u4e00\u4e2a Java \u6587\u4ef6\u7684\u5b57\u8282\u7801",permalink:"/blog/step-by-step-guide-to-reading-bytecode-of-a-java-file"}},r={authorsImageUrls:[void 0]},c=[{value:"\u5236\u4f5c\u52a0\u5bc6 class",id:"\u5236\u4f5c\u52a0\u5bc6-class",level:2},{value:"\u76ee\u6807\u7c7b",id:"\u76ee\u6807\u7c7b",level:3},{value:"\u52a0\u5bc6",id:"\u52a0\u5bc6",level:3},{value:"\u52a0\u8f7d",id:"\u52a0\u8f7d",level:2},{value:"\u8fd0\u884c\u7ed3\u679c",id:"\u8fd0\u884c\u7ed3\u679c",level:2},{value:"\u539f\u7406",id:"\u539f\u7406",level:2}];function d(e){const n={code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,s.a)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"\u8ddf\u7740\u6211\u4f53\u9a8c\u4e00\u4e0b\u4f20\u8bf4\u4e2d\u975e\u5e38\u5389\u5bb3\u7684\u7c7b\u52a0\u8f7d\u5668\u5427\uff01"}),"\n",(0,l.jsx)(n.h2,{id:"\u5236\u4f5c\u52a0\u5bc6-class",children:"\u5236\u4f5c\u52a0\u5bc6 class"}),"\n",(0,l.jsx)(n.h3,{id:"\u76ee\u6807\u7c7b",children:"\u76ee\u6807\u7c7b"}),"\n",(0,l.jsxs)(n.p,{children:["\u6211\u4eec\u8981\u52a0\u8f7d\u7684\u7c7b\u5f88\u7b80\u5355\uff0c\u5b83\u53ea\u6709\u4e00\u4e2a ",(0,l.jsx)(n.code,{children:"hello()"})," \u65b9\u6cd5\u3002\u7f16\u8bd1\u8fd9\u4e2a\u7c7b\u751f\u6210 class \u6587\u4ef6\uff0c\u5f85\u4f1a\u8981\u7528"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package ClassLoader;\n\npublic class Hello {\n    public void hello(){ \n        System.out.println("Hello, classLoader!"); \n    }\n    public static void main(String[] args) {\n        System.out.println();\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"\u52a0\u5bc6",children:"\u52a0\u5bc6"}),"\n",(0,l.jsx)(n.p,{children:"\u4e0b\u9762\u8fd9\u6bb5\u4ee3\u7801\u8bfb\u53d6\u4e86\u521a\u624d\u751f\u6210\u7684 Hello.class \uff0c\u52a0\u5bc6\u4e4b\u540e\u4fdd\u5b58\u4e3a Hello.xlass"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"encode()"})," \u5b9e\u73b0\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u52a0\u5bc6\uff0c\u52a0\u8f7d\u7c7b\u7684\u65f6\u5019\u4f7f\u7528\u540c\u6837\u7684\u65b9\u6cd5\u5c31\u53ef\u4ee5\u89e3\u5bc6"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package ClassLoader;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\n\n/**\n * @author : solidSpoon\n * @date : 2021/3/5 1:57\n */\npublic class EncodeFile {\n\n    public static void main(String[] args) {\n        String name = "Hello";\n        EncodeFile ef = new EncodeFile();\n        byte[] fileByteArray = ef.loadFile(name);\n        fileByteArray = ef.encode(fileByteArray);;\n        ef.storeFile(fileByteArray, name);\n    }\n    public byte[] loadFile(String name){\n        File f = new File(this.getClass().getResource(name + ".class").getPath());\n        byte[] fileByteArray = new byte[(int)f.length()];\n        try {\n            new FileInputStream(f).read(fileByteArray);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return fileByteArray;\n    }\n    void storeFile(byte[] fileByteArray, String name) {\n        String p = this.getClass().getResource("").getPath();\n        File file = new File(p + "/" + name + ".xlass");\n        try (FileOutputStream fop = new FileOutputStream(file)) {\n            if (!file.exists()) {\n                file.createNewFile();\n            }\n            fop.write(fileByteArray);\n            fop.flush();\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n\n    }\n    public byte[] encode (byte[] fileToEncode){\n        for(int i=0; i< fileToEncode.length; i++){\n            fileToEncode[i] = (byte) (255 - fileToEncode[i]);\n        }\n        return fileToEncode;\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u52a0\u8f7d",children:"\u52a0\u8f7d"}),"\n",(0,l.jsxs)(n.p,{children:["\u63a5\u4e0b\u6765\u6211\u4eec\u5b9a\u4e49\u81ea\u5df1\u7684\u52a0\u8f7d\u5668\uff0c\u628a\u521a\u624d\u7684 xlass \u6587\u4ef6\u89e3\u5bc6\u4e4b\u540e\u52a0\u8f7d\u5230 JVM \u4e2d\uff0c\u5e76\u53cd\u5c04\u8fd0\u884c\u5b83\u7684 ",(0,l.jsx)(n.code,{children:"hello()"})," \u65b9\u6cd5\u3002"]}),"\n",(0,l.jsxs)(n.p,{children:["\u5177\u4f53\u65b9\u6cd5\u662f\u7ee7\u627f ",(0,l.jsx)(n.code,{children:"ClassLoader"})," \u7c7b\uff0c\u8986\u76d6\u5b83\u7684 ",(0,l.jsx)(n.code,{children:"findClass()"})," \u65b9\u6cd5\uff0c\u5728\u8be5\u65b9\u6cd5\u4e2d\u4f7f\u7528 ",(0,l.jsx)(n.code,{children:"defineClass()"})," \u5c06\u5b57\u8282\u6d41\u8f6c\u6210 ",(0,l.jsx)(n.code,{children:"Class"})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'package ClassLoader;\n\nimport java.io.File;\nimport java.io.FileInputStream;\nimport java.lang.reflect.Method;\n\n/**\n * @author : solidSpoon\n * @date : 2021/3/5 1:30\n */\n\npublic class MyClassLoader extends ClassLoader{\n    public static void main(String[] args) {\n        try {\n            Class<?> clazz = new  MyClassLoader().findClass("Hello");\n            Object obj = clazz.getConstructor().newInstance();\n            Method method = clazz.getMethod("hello");\n            method.invoke(obj);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n\n    @Override\n    protected Class<?> findClass(String name) throws ClassNotFoundException {\n        File f = new File(this.getClass().getResource(name + ".xlass").getPath());\n        byte[] fileByteArray = new byte[(int)f.length()];\n        try {\n            new FileInputStream(f).read(fileByteArray);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        fileByteArray = decode(fileByteArray);\n        String pack = this.getClass().getPackage().getName();\n        return defineClass(pack + "." + name, fileByteArray, 0, fileByteArray.length);\n    }\n    /**\n     * \u5c06\u7f16\u7801\u8fc7\u7684\u5b57\u8282\u6570\u7ec4\u89e3\u7801\n     * @param fileToDecode \u8981\u89e3\u7801\u7684\u5b57\u8282\u6570\u7ec4\n     * @return \u89e3\u7801\u7684\u5b57\u8282\u6570\u7ec4\n     */\n    public byte[] decode (byte[] fileToDecode){\n        for(int i=0; i< fileToDecode.length; i++){\n            fileToDecode[i] = (byte) (255 - fileToDecode[i]);\n        }\n        return fileToDecode;\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"\u8fd0\u884c\u7ed3\u679c",children:"\u8fd0\u884c\u7ed3\u679c"}),"\n",(0,l.jsx)(n.p,{children:"\u6211\u4eec\u7684\u7c7b\u52a0\u8f7d\u5668\u89e3\u5bc6\u4e86 xlass \u5e76\u5c06\u5b83\u52a0\u8f7d\u5230\u4e86 JVM \u4e2d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"Hello, classLoader!\n"})}),"\n",(0,l.jsx)(n.h2,{id:"\u539f\u7406",children:"\u539f\u7406"}),"\n",(0,l.jsx)(n.p,{children:"\u7c7b\u52a0\u8f7d\u7684\u539f\u5219\u662f\u53cc\u4eb2\u59d4\u6d3e\u6a21\u578b\uff1a\u5982\u679c\u4e00\u4e2a\u7c7b\u52a0\u8f7d\u5668\u6536\u5230\u4e86\u7c7b\u52a0\u8f7d\u7684\u8bf7\u6c42\uff0c\u5b83\u9996\u5148\u4f1a\u628a\u8fd9\u4e2a\u8bf7\u6c42\u59d4\u6d3e\u7ed9\u7236\u7c7b\u52a0\u8f7d\u5668\u53bb\u5b8c\u6210\uff0c\u6bcf\u4e00\u4e2a\u5c42\u6b21\u7684\u7c7b\u52a0\u8f7d\u5668\u90fd\u662f\u5982\u6b64\uff0c\u56e0\u6b64\u6240\u6709\u7684\u52a0\u8f7d\u8bf7\u6c42\u6700\u7ec8\u90fd\u5e94\u8be5\u4f20\u9001\u5230\u6700\u9876\u5c42\u7684\u542f\u52a8\u7c7b\u52a0\u8f7d\u5668\u4e2d\uff0c\u53ea\u6709\u5f53\u7236\u52a0\u8f7d\u5668\u53cd\u9988\u81ea\u5df1\u65e0\u6cd5\u5b8c\u6210\u8fd9\u4e2a\u52a0\u8f7d\u8bf7\u6c42\uff08\u5b83\u7684\u641c\u7d22\u8303\u56f4\u4e2d\u6ca1\u6709\u627e\u5230\u6240\u9700\u7684\u7c7b\uff09\u65f6\uff0c\u5b50\u52a0\u8f7d\u5668\u624d\u4f1a\u5c1d\u8bd5\u81ea\u5df1\u53bb\u5b8c\u6210\u52a0\u8f7d\u3002"}),"\n",(0,l.jsxs)(n.p,{children:["\u6211\u4eec\u5b9a\u4e49\u7684\u8fd9\u4e2a ",(0,l.jsx)(n.code,{children:"findClass()"})," \u65b9\u6cd5\u4f1a\u5728\u4e0b\u9762\u8fd9\u4e2a\u5730\u65b9\u8c03\u7528\uff0c\u5982\u4ee3\u7801\u6240\u793a\uff0c\u5982\u679c\u8be5\u7c7b\u8fd8\u6ca1\u6709\u88ab\u52a0\u8f7d\u5e76\u4e14\u7236\u52a0\u8f7d\u5668\u65e0\u6cd5\u52a0\u8f7d\u4e2a\u7c7b\uff08\u5f53\u7136\u80af\u5b9a\u4e0d\u80fd\u52a0\u8f7d\uff09\uff0c\u5c31\u4f1a\u8c03\u7528\u6211\u4eec\u5b9a\u4e49\u7684 ",(0,l.jsx)(n.code,{children:"findClass()"})," \u53bb\u52a0\u8f7d\u8fd9\u4e2a\u7c7b"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"// java.lang ClassLoader\n\n\tprotected Class<?> loadClass(String name, boolean resolve)\n        throws ClassNotFoundException\n    {\n        synchronized (getClassLoadingLock(name)) {\n            // First, check if the class has already been loaded\n            Class<?> c = findLoadedClass(name);\n            if (c == null) {\n                long t0 = System.nanoTime();\n                try {\n                    if (parent != null) {\n                        c = parent.loadClass(name, false);\n                    } else {\n                        c = findBootstrapClassOrNull(name);\n                    }\n                } catch (ClassNotFoundException e) {\n                    // ClassNotFoundException thrown if class not found\n                    // from the non-null parent class loader\n                }\n\n                if (c == null) {\n                    // If still not found, then invoke findClass in order\n                    // to find the class.\n                    long t1 = System.nanoTime();\n                    c = findClass(name);\n\n                    // this is the defining class loader; record the stats\n                    PerfCounter.getParentDelegationTime().addTime(t1 - t0);\n                    PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);\n                    PerfCounter.getFindClasses().increment();\n                }\n            }\n            if (resolve) {\n                resolveClass(c);\n            }\n            return c;\n        }\n    }\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},1151:(e,n,a)=>{a.d(n,{Z:()=>o,a:()=>i});var l=a(7294);const s={},t=l.createContext(s);function i(e){const n=l.useContext(t);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),l.createElement(t.Provider,{value:n},e.children)}}}]);